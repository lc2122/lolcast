<!DOCTYPE html>
<html lang="ko" style="height:100%">
  <head>
    <title>
      같이보기
    </title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="robots" content="none">
	
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <style type="text/css">
      .modal-backdrop.in {
        filter: alpha(opacity=25);
        opacity: .25;
      }
      .videoListTitle {
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
      }
      .videoListControl {
        white-space: nowrap;
      }
      .videoListControl i {
        cursor: pointer;
        color: grey;
        transition: all 0.5s ease-in-out 0s;
        margin-right: 10px;
      }
      [data-tooltip-text]:hover {
	    position: relatvie;
	  }
	  [data-tooltip-text]:hover:after {
	    content: attr(data-tooltip-text);
		
		position: absolute; top:20px; right:30px;
		-webkit-box-shadow: 0px 0px 3px 1px rgba(50, 50, 50, 0.4);
	    -moz-box-shadow: 0px 0px 3px 1px rgba(50, 50, 50, 0.4);
	    box-shadow: 0px 0px 3px 1px rgba(50, 50, 50, 0.4);
		padding-left: 4px;
		padding-right: 4px;

	    -webkit-border-radius: 5px;
	    -moz-border-radius: 5px;
	    border-radius: 5px;

		background-color: rgba(0, 0, 0, 0.7); color:white;
		
		z-index:999;
	  }
	  @media (max-width: 767px){
		#videoListTable.twinkle0 .twinkle1{
			display: none !important;
		}
		#videoListTable.twinkle0 .twinkle2{
			display: none !important;
		}
		#videoListTable.twinkle1 .twinkle0{
			display: none !important;
		}
		#videoListTable.twinkle1 .twinkle2{
			display: none !important;
		}
		#videoListTable.twinkle2 .twinkle0{
			display: none !important;
		}
		#videoListTable.twinkle2 .twinkle1{
			display: none !important;
		}
	  }
	  #videoListTable col.twinkle2 {
	      width : 40px;
	  }
	  @media (max-width: 767px){
	    #videoListTable col.twinkle2 {
			width : 80px;
		}
	  }
    </style>
  </head>
  <body style="background-color:#fff; height:100%;">
    <div onclick="return togglepcdiv(event);" style="z-index: 5; position: absolute; background-color: rgba(0, 0, 0, 0.25); width: 25px; left: 0px; height: 25px; transform: rotate(0deg); transition: all 0.5s ease-in-out 0s;" id="togglediv"><i class="fa fa-arrow-up
      " style="cursor: pointer; color: white; height: 25px; line-height: 25px; font-size: 25px; display: inline-block;"></i></div>
    <div id="pcdiv" style="display: block;">
      <div style="width: 100%;height: 25px;padding-left: 25px;display: table;border-collapse: separate;border-spacing: 10px 0;">
        <div onclick="return mainskip(event, 1);" style="display: table-cell;vertical-align: middle;width: auto;padding: 0;">
          <i id="likemain" class="fa fa-thumbs-up" style="
            cursor: pointer;
            color: grey;
            line-height: 24px;
            font-size: 20px;
            transition: all 0.5s ease-in-out 0s;
            "></i>
        </div>
        <div style="display: table-cell;vertical-align: middle;width: 90%;padding: 0;text-align: center;height: 24px; font-size:0px;">
          <div id="greendiv" style="height: 50%; width: 30%; display: inline-block; background-color: green; transition: all 0.5s ease-in-out 0s;"></div>
          <div id="greydiv1" style="height: 50%; display: inline-block; width: 10%; background-color: grey; transition: all 0.5s ease-in-out 0s;"></div>
          <div id="redline" style="height: 50%; width: 5px; display: inline-block; background-color: red; transition: all 0.5s ease-in-out 0s;"></div>
          <div id="greydiv2" style="height: 50%; display: inline-block; width: 20%; background-color: grey; transition: all 0.5s ease-in-out 0s;"></div>
          <div id="reddiv" style="height: 50%; width: 30%; display: inline-block; background-color: red; transition: all 0.5s ease-in-out 0s;"></div>
        </div>
        <div onclick="return mainskip(event, -1);" style="display: table-cell;vertical-align: middle;width: auto;padding: 0;">
          <i id="dislikemain" class="fa fa-thumbs-down" style="
            cursor: pointer;
            color: grey;
            font-size: 20px;
            line-height: 24px;
            transition: all 0.5s ease-in-out 0s;
            "></i>
        </div>
        <span id="playTime" style="
          font-size: 14px;
          display: table-cell;
          vertical-align: middle;
          width: auto;
          "> 1:51/2:12 </span>
        <div data-toggle="modal" data-target="#videoListModal" style="display: table-cell;vertical-align: middle;width: auto;padding: 0;">
          <i class="fa fa-bars
            " style="
            cursor: pointer;
            color: grey;
            line-height: 24px;
            font-size: 20px;
            "></i>
        </div>
      </div>
    </div>
    <div class="modal fade" id="videoListModal" role="dialog" style="display: none;">
      <div class="modal-dialog modal-align-bottom-right" style="bottom: auto; right: 0; top: 0; margin: 0; position: absolute; overflow-y: auto; max-height: 100%;">
        <div class="modal-content">
          <div class="modal-body">
            <table id="videoListTable" class="table table-condensed table-striped twinkle0" style="
              table-layout: fixed;
              ">
              <colgroup>                
                <col span="1" style="width: 90%;">
                <col class="twinkle0" span="1" style="width: 55px;">
                <col class="twinkle1" span="1" style="width: 80px;">
				<col class="twinkle2" span="1">
                <col span="1" style="width: 105px;">
              </colgroup>
              <thead>
                <tr>
                  <th scope="col">제목</th>				  
                  <th scope="col" class="twinkle0">시간</th>
                  <th scope="col" class="twinkle1">신청자</th>
				  <th scope="col" class="twinkle2">중복</th>
                  <th scope="col"><button type="button" class="close" data-dismiss="modal">×</button></th>
                </tr>
              </thead>
              <tbody id="videoList">
              </tbody>
            </table>
            <div class="input-group input-group-sm">
              <span class="input-group-btn">
              <button onclick="return toggleplaytimeinputs(event);" id="toggleinputs" class="btn btn-default" type="button" style="
                transform: rotate(0deg);
                transition: all 0.5s ease-in-out 0s;
                "><i class="fa fa-arrow-down
                " style="cursor: pointer;color: black;"></i></button>
              </span><input id="urlinput" type="url" class="form-control" placeholder="URL" style="
                ">
              <span class="input-group-btn">
                <button onclick="return addvideo(event);" class="btn btn-default" type="button">추가</button>
              </span>
            </div>
            <div id="playtimeinputs" class="input-group input-group-sm" style="
              margin-top: 5px;
              margin-left: 33px;
              margin-right: 45px;
              ">
              <input id="starttimeinput" type="number" class="form-control" placeholder="시작시간(초)" value=0>
              <span class="input-group-addon"> ~ </span><input id="endtimeinput" type="number" class="form-control" placeholder="종료시간(초)" value=0>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="syncplayer" id="syncplayerwarper" style="height:100%; overflow:hidden; padding-top:25px; margin-top:-25px;">
      <div id="syncplayer"></div>
    </div>
    
    <div id="lcwarper" style="height:100%; overflow:hidden; padding-top:25px; margin-top:-25px;">
      <div style="height:100%; width:100%; background-color:black;">
        <iframe id="lciframe" frameborder="0" src="about:blank" value="transparent" width="100%" height="100%" marginwidth="0" marginheight="0"></iframe>
      </div>
    </div>
    
    <div id="totonotifications" style="position:absolute; width:100%; opacity:0.8; z-index:5; bottom:0;"></div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script type='text/javascript'>
function escapeURL(str) {
  var code, i, len;
  
  var x = "";
  
  for (i = 0, len = str.length; i < len; i++) {
    code = str.charCodeAt(i);
    if (!(code > 47 && code < 58) && // numeric (0-9)
        !(code > 64 && code < 91) && // upper alpha (A-Z)
        !(code > 96 && code < 123) && // upper alpha (A-Z)
        !(code === 95) && // underbar (_)
		!(code === 45)) { // bar (-)
      x += "%"+code;
    } else {
	  x += str.charAt(i);
	}
  }
  return x;
}

function escapeHtml(str) {
  var pcode, code, i, len;
  
  var code = 0;
  
  var x = "";
  
  var c = false;
  
  for (i = 0, len = str.length; i < len; i++) {
    pcode = code;
    code = str.charCodeAt(i);
	if (0xD800 <= code && code <= 0xDBFF) {
	    continue;
	}
	if (0xD800 <= pcode && pcode <= 0xDBFF) {
	    x += "&#"+((((Number(pcode)-0xD800)*0x400) + (Number(code)-0xDC00) + 0x10000))+";";
	    continue;
	}
    if (!(code > 47 && code < 58) && // numeric (0-9)
        !(code > 64 && code < 91) && // upper alpha (A-Z)
        !(code > 96 && code < 123)) { // lower alpha (a-z)
      x += "&#"+code+";";
    } else {
	  x += str.charAt(i);
	}
  }
  return x;
}

iframe = (function() {
    var iframe;
    var origin = "https://insagirl-toto.appspot.com";
	//var origin = "http://127.0.0.1:8080";
    
    function accessible(theiframe) {
        var thedoc;
        try {
            thedoc = (theiframe.contentWindow || theiframe.contentDocument);
            if (thedoc.document)
                thedoc = thedoc.document;
            return true;
        } catch (err) {
            return false;
        }
    }
    
    return {
        send: function send(x) {
            if (iframe)
                iframe.postMessage(JSON.stringify(x), origin);
            else {
                var frames = window.parent.frames;

                for (var i = 0; i < frames.length; i++) {
                    frames[i].postMessage(JSON.stringify(x), origin);
                }
            }
        },
        setReceiver: function setReceiver(f) {
            window.addEventListener("message", function(e) {
                if (e.origin !== origin)
                    return;
                try {
                    iframe = e.source;
				    if(accessible(iframe)){
                      if (iframe.location.href.indexOf(window.location.href) === -1)
                        f(JSON.parse(e.data));
                    } else {
                      f(JSON.parse(e.data));
                    }
                } catch (err) {
                    console.log(err);
                }
            }, false);
        }
    };

})();

var onYouTubeIframeAPIReady;

var addvideo;

var tabledelete;

var tableskip;

var mainskip;

function loadlciframe(url){
    if(url){
      //load('main/page/player.php', {'ser':q[2], 'name':q[3], 'embed':q[4],'3ser':q[5],'4ser':q[6]});
      var x = url.split("/");
      
      var src = "https://lolcast.kr/main/page/player.php?";
      
      var qname = ["", "ser", "name", "embed", "3ser", "4ser"];
	  
	  if(x[1] === "youtube"){
	    src = "https://www.youtube.com/embed/"+escapeURL(x[2]);
	  } else if (x[1] === "twitch") {
	    src = "https://player.twitch.tv/?channel="+escapeURL(x[2])+"&parent=insagirl.github.io&parent=lolcast.kr";
	  } else {
		  for(var i=1, len=x.length; i<len; i++){
			  src += qname[i] + "=" + encodeURIComponent(x[i]);
				  
			  if(i < len-1)
				  src += "&"
		  }
	  }
      
      $("#syncplayerwarper").hide();
      $("#lciframe").attr("src", src)
      $("#lcwarper").show();
    } else {
      $("#syncplayerwarper").show();
      $("#lciframe").attr("src", "about:blank")
      $("#lcwarper").hide();
    }
}

function newToggler(toggler, toggled, f) {
    var deg = 0;
    return function(e) {
        if (typeof e === "undefined" || !e)
            return true;
        e.preventDefault();
        deg += 180;
        if (deg > 360 && deg % 360 === 0 && Math.random() < 0.5)
            deg = 0;
        if ($(toggled).is(':visible')) {
            $(toggler).css({
                'transform': 'rotate(' + deg + 'deg)'
            });
            $(toggled).slideUp(500);
            
            if (typeof f !== "undefined" && f)
                f(false);                
        } else {
            $(toggler).css({
                'transform': 'rotate(' + deg + 'deg)'
            });
            $(toggled).slideDown(500);
            
            if (typeof f !== "undefined" && f)
                f(true);                
        }
        return false;
    };
}

var togglepcdiv = newToggler("#togglediv", "#pcdiv", function(b){
  if(b){
    $("#syncplayerwarper").css({
                    'padding-top': '25px',
                    'margin-top': '-25px'
    });
    $("#lcwarper").css({
                    'padding-top': '25px',
                    'margin-top': '-25px'
    });
  }
  else {
    $("#syncplayerwarper").css({
                    'padding-top': '0',
                    'margin-top': '-0'
    });
    $("#lcwarper").css({
                    'padding-top': '0',
                    'margin-top': '-0'
    });
  }
});

var toggleplaytimeinputs = newToggler("#toggleinputs", "#playtimeinputs", function(b){
  if(b){

  } else {
    document.getElementById("starttimeinput").value = 0;
    document.getElementById("endtimeinput").value = 0;
  }
});

window.onload = function() {
    $("#playtimeinputs").hide();

    var tag = document.createElement("link");
    tag.setAttribute("rel", "stylesheet");
    tag.setAttribute("href", "https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css");
    document.getElementsByTagName("head")[0].appendChild(tag);

    tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.getElementsByTagName('script')[0].parentNode.insertBefore(tag, document.getElementsByTagName('script')[0]);

    syncplayer = (function() {
    
        var videoList = [];

        var userNm = 1;

        var myvid = "0";
        var mystart = 0;
        var myduration = 73000;
        var mytime = 0;
        var myupdated = (new Date()).getTime();
        
        var serverupdated = (new Date()).getTime() - 5000;
        
        var serversynced = (new Date()).getTime();
        
        
        var myskip = [0, 0];

        //var debugtime = 0;

        var userskip = [];

        var isloaded = false;

        var player;
        
        var playfail = true;

        /* --- 수정된 부분 시작 --- */
        var cueTimestamp = 0; // 새 영상이 로드된 시간을 기록하는 타임스탬프
        /* --- 수정된 부분 끝 --- */
		
		var tablecache = "";
		
		var tabletwinkle = 0;
        
        var videoInfo = (function(){
          var videoInfoList = [];
          
          function shrink(videoList){
            var newList = [];
            for(var i=0, len=videoInfoList.length; i<len; i++){
                var has = false;
                for(var j=0, jlen=videoList.length; j<jlen; j++){
                    if (videoInfoList[i][0] === videoList[j].vid) {
                       has = true;
                    }
                }
                if(has)
                  newList.push(videoInfoList[i]);
            }
            videoInfoList = newList;
          }
          
          return {
            updateSkip: function updateSkip(){
              for (var j=0, jlen = userskip.length; j < jlen; j++) {
                  for(var i=0, len=videoInfoList.length; i<len; i++){
                      if (videoInfoList[i][0] === userskip[j][0]) {
                          videoInfoList[i][2] = userskip[j][1];
                      }
                  }
                  
              }
            },
            get: function get(vid, idx){
              for(var i=0, len=videoInfoList.length; i<len; i++){
                  if (videoInfoList[i][0] === vid) {
                     return videoInfoList[i];
                  }
              }
              
              var x = [vid, "loading", 0, "?", "loading"];
                  
              videoInfoList.push(x);
              
              if(vid.charAt(0) !== "/")
                $.getJSON( "https://www.youtube.com/oembed?url=http%3A//youtube.com/watch%3Fv%3D"+vid+"&format=json", function( data ) {
                  x[1] = data.title;
                });
              else
                  x[1] = vid;
			  
			  $.ajax({
			    url: "https://insagirl-hrm.appspot.com/sc/?v="+encodeURIComponent(vid),
                dataType: 'jsonp',
				success: function( data ) {
				x[3] = Number(data["v"][0]);
				
				if(idx == 0 && x[3] > 0)
				  x[3]--;  
				
				if(data["v"][1] < 0){
				  x[4] = "재생된 적 없음";
			    }
			    else{
				  var now = (new Date()).getTime();
				  var totalSec = Math.floor((now - data["v"][1]) / 1000);
				  var days = parseInt(totalSec / 86400);
				  var hours = parseInt(totalSec / 3600) % 24;
				  var minutes = parseInt(totalSec / 60) % 60;
				  var seconds = totalSec % 60;
				  
				  days = (days == 0) ? "" : (days + "일 ");
				  hours = (hours == 0) ? "" : (hours + "시간 ");
				  minutes = (minutes == 0) ? "" : (minutes + "분 ");
				  seconds = (seconds == 0) ? "" : (seconds + "초 ");
				  
				  x[4] = days+hours+minutes+seconds+"전에 마지막으로 재생됨"
				}
				
				
			    }
			  })
              
              if(videoInfoList.length > 20)
                shrink(videoList)
              
              return x;
            }
          }
        })();


        function secondsTommss(seconds) {
            function addzero(x) {
                if (x < 10)
                    return "0" + String(x);
                else
                    return String(x);
            }

            var mm = ~~(seconds / 60);
            var ss = ~~(seconds % 60);

            if (ss < 0) {
                ss = -ss;
                return "-" + mm + ":" + addzero(ss);
            }
            return mm + ":" + addzero(ss);
        }

        function updateUserSkip() {
            var matched = false;
            for (var i = 0, len = userskip.length; i < len; i++) {
                if (myvid === userskip[i][0]) {
                    matched = true;
                    if (userskip[i][1] < 0) {
                        $("#dislikemain").css({
                            'color': 'red'
                        });
                        $("#likemain").css({
                            'color': 'grey'
                        });
                    } else if (userskip[i][1] > 0) {
                        $("#likemain").css({
                            'color': 'green'
                        });
                        $("#dislikemain").css({
                            'color': 'grey'
                        });
                    } else {
                        $("#dislikemain").css({
                            'color': 'grey'
                        });
                        $("#likemain").css({
                            'color': 'grey'
                        });
                    }
                }
            }
            if(!matched){
                $("#dislikemain").css({
                    'color': 'grey'
                });
                $("#likemain").css({
                    'color': 'grey'
                });
            }
            videoInfo.updateSkip();
        }

        function viewupdate(updatetable) {
            //$("#debugTime").text(debugtime);
            
            if(myduration < 86400000)
                $("#playTime").text(secondsTommss(~~((mytime-mystart) / 1000)) + "/" + secondsTommss(~~(myduration / 1000)));
            else
                $("#playTime").text(secondsTommss(~~((mytime-mystart) / 1000)) + "/" + secondsTommss(~~(0 / 1000)));
            
            if(!updatetable)
              return;

            var green = Math.floor(myskip[0] / userNm * 90);
            var red = Math.floor(myskip[1] / userNm * 90);
            var grey1 = 90 - red - green;
            var grey2 = 18 + green - red;
            if(grey2 < 0){
              grey2 = 0;
              $("#redline").hide();
            } else {
              $("#redline").show();              
            }
            
            grey1 = grey1 - grey2;
            
            if(grey1 < 0){
              grey2 += grey1;
              grey1 = 0;
              $("#redline").hide();
            }

            $("#greendiv").css({
                'width': green + "%"
            });
            $("#greydiv1").css({
                'width': grey1 + "%"
            });
            $("#greydiv2").css({
                'width': grey2 + "%"
            });
            $("#reddiv").css({
                'width': red + "%"
            });
            
            updateUserSkip();
            
            if(!$('#videoListModal').hasClass('in'))
              return;
              
            var tbody = "";

            for (var i = 0, len = videoList.length; i < len; i++) {
                var vinfo = videoInfo.get(videoList[i].vid, i);
                tbody += '<tr id="' + videoList[i].vid + '">';
                if(videoList[i].duration < 86400000)
                    tbody += '<td class="videoListTitle"><a href="https://youtu.be/' + videoList[i].vid + '" target="_blank">' + escapeHtml(vinfo[1]) + '</a></td><td class="twinkle0">' + secondsTommss(~~(videoList[i].duration / 1000)) + '</td><td class="twinkle1 videoListTitle">'+escapeHtml(videoList[i].nick)+'</td>';
                else
                    tbody += '<td class="videoListTitle"><a href="https://lolcast.kr/#/player' + encodeURI(videoList[i].vid) + '" target="_blank">' + escapeHtml(vinfo[1]) + '</a></td><td class="twinkle0">실시간</td><td class="twinkle1 videoListTitle">'+escapeHtml(videoList[i].nick)+'</td>';
                
				tbody += '<td style="cursor: pointer;" data-tooltip-text="' + vinfo[4] + '" scope="row" class="twinkle2">' + vinfo[3] + '</td>';
				
				if(vinfo[2] === 1)
                  tbody += '<td class="videoListControl"><span onclick="return tableskip(event, -1);"><i class="fa fa-thumbs-up" style="color: green;"></i></span><span onclick="return tableskip(event, -1);"><i class="fa fa-thumbs-down"></i></span>'
                else if (vinfo[2] === -1)
                  tbody += '<td class="videoListControl"><span onclick="return tableskip(event, 1);"><i class="fa fa-thumbs-up"></i></span><span onclick="return tableskip(event, 1);"><i class="fa fa-thumbs-down" style="color: red;"></i></span>'
                else
                  tbody += '<td class="videoListControl"><span onclick="return tableskip(event, 1);"><i class="fa fa-thumbs-up"></i></span><span onclick="return tableskip(event, -1);"><i class="fa fa-thumbs-down"></i></span>'
                
                tbody += '<span onclick="return skiplist(event);"><i class="fa fa-info"></i></span>'
                
                if(videoList[i].nick === mynick || mylevel === "관리자" || mylevel === "생성자" || mylevel === "운영자")
                  tbody += '<span onclick="return tabledelete(event);"><i class="fa fa-trash" style="color: red;"></i></span>';
                
                tbody += '</td></tr>'
            }
			
			tabletwinkle++;
			tabletwinkle = tabletwinkle % 3;
			$("#videoListTable").removeClass("twinkle0").removeClass("twinkle1").removeClass("twinkle2").addClass("twinkle" + tabletwinkle);
			if(tablecache === tbody)
			  return;
			  
		    tablecache = tbody;

            document.getElementById("videoList").innerHTML = tbody;
        }

        function getPlayTime() {
            var maybetime = mytime + (new Date()).getTime() - myupdated;
            
            if(myduration > 86400000){
				if(playfail && maybetime - mystart > 3000)
					playfail = false;
                return [maybetime, "t"];
            }
            
            if (isloaded) {
                /* --- 수정된 부분 시작 --- */
                if (playfail) {
                    // 1. 재생 성공 감지 (광고 처리 포함)
                    if (player.getPlayerState() === 1) {
                        var expectedStartTime = mystart / 1000;
                        var currentTime = player.getCurrentTime();
                        if (currentTime >= expectedStartTime && currentTime < expectedStartTime + 5) {
                            playfail = false; // 재생 성공!
                            cueTimestamp = 0; // 타이머 리셋
                            seekTo(mytime);   // 정확한 시간으로 보정
                        }
                    }

                    // 2. 타임아웃 감지 (재생 성공하지 못했을 경우)
                    var TIMEOUT_SECONDS = 15; // 15초 이상 재생 안되면 타임아웃
                    if (cueTimestamp > 0 && (new Date().getTime() - cueTimestamp > TIMEOUT_SECONDS * 1000)) {
                        notification.add("영상 재생이 15초 이상 지연되어 건너뜁니다.", "warning");
                        mainskip(null, -1, true); // 자동으로 건너뛰기 신호 전송
                        cueTimestamp = 0; // 타이머 리셋
                    }
                }
                /* --- 수정된 부분 끝 --- */

                if ((player.getPlayerState() === 5 || player.getPlayerState() === 2) && maybetime > mystart) {
                    player.playVideo();
                    return [maybetime, "t"];
                } else if (player.getPlayerState() === 0) {
                    return [maybetime, "t"];
                } else if (player.getPlayerState() === 3) {
                    return [~~(player.getCurrentTime() * 1000), "f"];
                } else if (player.getPlayerState() === 1) {
                    return [~~(player.getCurrentTime() * 1000), "t"];
                }
            }

            if (maybetime < mystart) {
                return [maybetime, "t"];
            } else {
                return [mystart, "f"];
            }
        }

        function seekTo(time) {
            mytime = time;
            myupdated = (new Date()).getTime();
            
            if(myduration > 86400000){
                return;
            }
            
            if (mytime < mystart) {
                if (isloaded)
                    player.pauseVideo();
                return;
            }

            if (isloaded) {
                if (player.getPlayerState() === 2)
                    player.playVideo();
                player.seekTo(time / 1000, true);
            }
        }

        function cueVideo(v, time) {
            if (myduration >= 86400000 || isloaded) {
				
				if(v.duration < 86400000 && myduration >= 86400000){
					playfail = true;
				}
				
                myvid = v.vid;
                mystart = v.start;
                myduration = v.duration;
                mytime = time;
                myupdated = (new Date()).getTime();
                myskip = v.skip;
                
                if(myduration < 86400000){
                    isloaded = false;                    
                    loadlciframe(false);                    
                    player.cueVideoById(myvid, v.start / 1000);
                } else {
                    //실시간 동영상                    
                    isloaded = false;
                    player.stopVideo();                    
                    loadlciframe(myvid);
                }

                /* --- 수정된 부분 시작 --- */
                cueTimestamp = (new Date()).getTime(); // 새 영상 로드 시간 기록
                /* --- 수정된 부분 끝 --- */
            }
        }
        
        function decode(videoList) {
			      var newList = [];
			      for(var i=0, len=videoList.length; i<len; i++){
				      var j = videoList[i];
				      newList.push({
					      vid: j[0],
					      duration: j[1]*1000,
					      nick: j[2],
					      time: j[3]*1000,
					      start: j[4]*1000,
					      skip: j[5]
				      });
			      }
            return newList;
        }

        return {
            updateFromServer: function updateFromServer(x) {
                userNm = x.n;
                videoList = decode(x.l);
                mytime = getPlayTime()[0];
                myupdated = (new Date()).getTime();
                serversynced = (new Date()).getTime();
                
                //{vid, duration, nick, time, start, skip}			
                if (videoList[0].vid === myvid) {
                    //debugtime = mytime - x.t;
                    if (x.t - 4000 > mytime || x.t + 2000 < mytime) {
                        seekTo(x.t);
                    }
                    myskip = videoList[0].skip;
                } else {
                    var searched = false;
                    var serverdmytime = videoList[0].start + videoList[0].duration;

                    for (var j = 1, jlen = videoList.length; j < jlen; j++) {
                        if (videoList[j].vid === myvid) {
                            searched = true;
                            serverdmytime += mytime - videoList[j].time;
                            break;
                        } else {
                            serverdmytime += videoList[j].duration + videoList[j].start - videoList[j].time;
                        }
                    }
                    if (!searched) {
                        serverdmytime = videoList[0].time - myduration + mytime - mystart;
                    }
                    //debugtime = serverdmytime - x.t;  || mytime - mystart >= myduration
                    if (x.t - 4000 > serverdmytime || x.t + 2000 < serverdmytime || mytime - mystart >= myduration) {
                        cueVideo(videoList[0], x.t);
                    }
                }
                viewupdate(true);
            },
            updateToServer: function updateToServer() {
                var playtime = getPlayTime();

                mytime = playtime[0];
                myupdated = (new Date()).getTime();
                
                if(myupdated - serversynced > 5000){
                    notification.add("서버와 접속이 원활하지 않습니다. 오른쪽 채팅창이 잘 켜져있나요?", "danger");
                    serversynced = myupdated;
                }
                                
                if (mytime - mystart >= myduration){
                    if(videoList[0].vid === myvid && videoList.length > 1){
                      cueVideo(videoList[1], videoList[1].time);
                    } else if(videoList[0].vid !== myvid){
                      cueVideo(videoList[0], videoList[0].time);
                    }
                }
                
                viewupdate(false);
                
                if(playfail && myduration < 86400000)
                  return [];
                
                if(myupdated - serverupdated > 1750){
                  serverupdated = myupdated;
                  return [myvid, mytime, playtime[1], myduration, mystart];  
                }
                
                return [];
            },
            onPlayerReady: function onPlayerReady() {
                isloaded = true;
            },
            onPlayerStateChange: function onPlayerStateChange(e) {
                /*YT.PlayerState.ENDED 0 
                  YT.PlayerState.PLAYING 1
                  YT.PlayerState.PAUSED 2 
                  YT.PlayerState.BUFFERING 3
                  YT.PlayerState.CUED 5*/
                if (e.data === YT.PlayerState.CUED)
                    isloaded = true;
            },
            setPlayer: function setPlayer(p) {
                player = p;
            },
            getPlayer: function getPlayer() {
                return player;
            },
            setSkip: function setSkip(sl){
                userskip = sl;
                updateUserSkip();
            },
            getMyvid: function getMyvid(){
                return myvid;
            },
            checkUserskip: function checkUserskip(vid){
                for (var i = 0, len = userskip.length; i < len; i++) {
                    if (vid === userskip[i][0])
                        return userskip[i][1];
                }
                return 0;
            },
            /* --- 수정된 부분 시작 --- */
            onPlayerError: function onPlayerError(event) {
                console.error("YouTube Player Error: ", event.data);
                notification.add("현재 영상을 재생할 수 없어 건너뜁니다. (지역락, 삭제된 영상 등)", "danger");
                // mainskip 함수를 호출하여 자동으로 '싫어요'를 보내 영상을 건너뛰도록 유도합니다.
                mainskip(null, -1, true); 
            }
            /* --- 수정된 부분 끝 --- */
        }
    })();
    

    var notification = (function() {
        return {
            //info, success, danger
            add: function add(message, level) {
                if (typeof level === "undefined")
                    level = "info";
                $('#totonotifications').append('<div data-created="' + (new Date()).getTime() + '" class="alert alert-dismissable alert-' + level + '"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>' + message + '</div>');
            },
            update: function update() {
                $('#totonotifications > div').filter(function() {
                    return $(this).attr("data-created") < (new Date()).getTime() - 5000;
                }).remove();
            }
        }
    })();
    
    var mynick = "User";
    var mylevel = "손님";
    
    function updateToServer() {
      notification.update();
      var mlist = syncplayer.updateToServer();
      if(mlist.length > 0){
        if(mylevel !== "밴" && mylevel !== "손님"){
          iframe.send({
            m: mlist.join(" "),
            n: "u"
          });
        }
      }
      setTimeout(updateToServer, 500);
    }
    
    updateToServer();
            
    iframe.setReceiver((function() {

        var videoList = (function() {
            return {

            }
        })();

        return function(x) {
            if(x.u)
              mynick = x.u;
            if(x.ul)
              mylevel = x.ul;
            switch (x.n) {
                case "f":
                    notification.add(x.m);
                    break;

                case "vl":
                    document.getElementById("urlinput").value = ""
                    document.getElementById("starttimeinput").value = 0;
                    document.getElementById("endtimeinput").value = 0;
                    break;

                case "sl":
                    syncplayer.setSkip(x.m);
                    break;

                case "b":
                    syncplayer.updateFromServer(x.m);
                    break;
                    
                case "lk":
                    mainskip(null, 1, true);
                    break;
                    
                case "dlk":
                    mainskip(null, -1, true);
                    break;
                  
                default:
            }
        }
    })());



    function youtube_parser(url) {
        var regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?v=))([^#&?]*).*/;
        var match = url.match(regExp);
        return (match && match[7].length == 11) ? match[7] : false;
    }
    
    function lolcast_parser(url) {
        var regExp = /^https:\/\/lolcast\.kr\/#\/player([-a-zA-Z0-9()@:%_\+.~#?&\/=]*)$/;
        var match = url.match(regExp);
        return (match && match[1]) ? match[1] : false;
    }
    
    addvideo = function(e){
      if (typeof e === "undefined" || !e)
        return true;
      e.preventDefault();
      
      var vid = youtube_parser(document.getElementById("urlinput").value);
      if(!vid){
        vid = lolcast_parser(document.getElementById("urlinput").value);
        if(!vid){
          notification.add("적절하지 않은 유튜브/롤캐 주소입니다.");
          return;
        }
      }
      var start = document.getElementById("starttimeinput").value;
      var end = document.getElementById("endtimeinput").value;
      
      iframe.send({
        m: vid+" "+start+" "+end,
        n: "a"
      });
    };
    
    tabledelete = function(e){
      if (typeof e === "undefined" || !e || typeof e.target === "undefined" || !e.target)
        return true;
      e.preventDefault();
      
      var tr = e.target;
      
      while(tr.tagName.toUpperCase() !== "TR")
        tr = tr.parentElement;
      
      var vid = tr.id;   
      if(!vid){
        return;
      }
            
      iframe.send({
        m: vid,
        n: "d"
      });
    };
    
    skiplist = function(e){
      if (typeof e === "undefined" || !e || typeof e.target === "undefined" || !e.target)
        return true;
      else
        e.preventDefault();
      
      var tr = e.target;
      
      while(tr.tagName.toUpperCase() !== "TR")
        tr = tr.parentElement;
      
      var vid = tr.id;   
      
      if(!vid){
        return;
      }
      
      iframe.send({
        m: vid,
        n: "sl"
      });
    };
    
    tableskip = function(e, s){
      if (typeof e === "undefined" || !e || typeof e.target === "undefined" || !e.target)
        return true;
      else
        e.preventDefault();
      
      var tr = e.target;
      
      while(tr.tagName.toUpperCase() !== "TR")
        tr = tr.parentElement;
      
      var vid = tr.id;   
      
      if(!vid){
        return;
      }
      
      iframe.send({
        m: vid+" "+(s===1 ? "t" : "f"),
        n: "s"
      });
    };
    
    mainskip = function(e, s, b){
      if(!b){
        if (typeof e === "undefined" || !e || typeof e.target === "undefined" || !e.target)
          return true;
        else
          e.preventDefault();
      }
      
      var vid = syncplayer.getMyvid();
      
      if(!vid){
        return;
      }
      
      var ss = syncplayer.checkUserskip(vid);
      
      if(ss)
        s = -ss;
      
      iframe.send({
        m: vid+" "+(s===1 ? "t" : "f"),
        n: "s"
      });
    };

    onYouTubeIframeAPIReady = function() {
        syncplayer.setPlayer(new YT.Player('syncplayer', {
            width: '100%',
            height: '100%',
            videoId: '0',
            events: {
                'onReady': syncplayer.onPlayerReady,
                'onStateChange': syncplayer.onPlayerStateChange,
                /* --- 수정된 부분 시작 --- */
                'onError': syncplayer.onPlayerError
                /* --- 수정된 부분 끝 --- */
            }
        }));
    }
};
    </script>
  </body>
</html>
