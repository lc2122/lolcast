<!DOCTYPE html>
<html>
<head>
  <title>HLS Player</title>
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.2/plyr.css" />
  <style>
    .container {
      margin: 100px auto;
      width: 70%;
    }
    video {
      width: 100%;
    }
  </style>
</head>
<body>
  <div class="container">
    <label for="m3u8Url">m3u8 URL:</label>
    <input type="text" id="m3u8Url" value="https://example.com/playlist.m3u8">
    <button id="loadBtn">Load</button>

    <video controls crossorigin playsinline poster="https://bitdash-a.akamaihd.net/content/sintel/poster.png"></video>
  </div>

  <script src="https://cdn.plyr.io/3.7.2/plyr.polyfilled.min.js"></script>
  <script src="https://cdn.rawgit.com/video-dev/hls.js/18bb552/dist/hls.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const video = document.querySelector('video');
      const m3u8UrlInput = document.getElementById('m3u8Url');
      const loadBtn = document.getElementById('loadBtn');
      let player;

      const defaultOptions = {};

      loadBtn.addEventListener('click', () => {
        const source = m3u8UrlInput.value;

        if (player) {
          player.destroy();
        }

        if (!Hls.isSupported()) {
          video.src = source;
          player = new Plyr(video, defaultOptions);
        } else {
          const hls = new Hls();
          hls.loadSource(source);

          hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
            const availableQualities = hls.levels.map((l) => l.height);
            availableQualities.unshift(0); // prepend 0 to quality array

            defaultOptions.quality = {
              default: 0, // Default - AUTO
              options: availableQualities,
              forced: true,
              onChange: (e) => updateQuality(e),
            };
            defaultOptions.i18n = {
              qualityLabel: {
                0: 'Auto',
              },
            };

            hls.on(Hls.Events.LEVEL_SWITCHED, (event, data) => {
              const span = document.querySelector(".plyr__menu__container [data-plyr='quality'][value='0'] span");
              if (hls.autoLevelEnabled) {
                span.innerHTML = `AUTO (${hls.levels[data.level].height}p)`;
              } else {
                span.innerHTML = 'AUTO';
              }
            });

            player = new Plyr(video, defaultOptions);
          });

          hls.attachMedia(video);
          window.hls = hls;
        }
      });

      function updateQuality(newQuality) {
        if (newQuality === 0) {
          window.hls.currentLevel = -1; // Enable AUTO quality if option.value = 0
        } else {
          window.hls.levels.forEach((level, levelIndex) => {
            if (level.height === newQuality) {
              console.log(`Found quality match with ${newQuality}`);
              window.hls.currentLevel = levelIndex;
            }
          });
        }
      }
    });
  </script>
</body>
</html>
